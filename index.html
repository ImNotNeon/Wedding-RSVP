<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Wedding RSVP</title>

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Raleway:wght@400;600&family=Tinos:wght@700&display=swap" rel="stylesheet">

  <style>
    body {
      font-family: 'Raleway', sans-serif;
      background: #c3bdb5 url('Wedding.gif') no-repeat center bottom fixed;
      background-size: cover;
      text-align: center;
      padding: 30px;
      color: #4B2E2E;
    }
    h1, h2 {
      font-family: 'Tinos', serif;
      font-weight: 700;
      font-size: 2.5em;
      color: #4B2E2E;
    }
    h3 {
      font-family: 'Raleway', sans-serif;
      font-weight: 500;
      font-size: 1.8em;
      color: #4B2E2E;
    }
    h4 {
      font-family: 'Raleway', sans-serif;
      font-weight: 500;
      font-size: 1.5em;
      color: #4B2E2E;
    }
    .screen {
      margin: 20px auto;
      max-width: 420px;
      background: #d4d0c7;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 12px rgba(0,0,0,0.2);
      display: none;
      position: relative;
    }
    input, button {
      width: 85%;
      padding: 10px;
      margin: 10px 0;
      font-family: 'Raleway', sans-serif;
      border-radius: 6px;
      border: 1px solid #c9b6b3;
    }
    button {
      background: #b5aba4;
      color: white;
      border: none;
      cursor: pointer;
      font-weight: 600;
      transition: background 0.3s ease;
    }
    button:hover {
      background: #c9b6b3;
    }
    #thankYou, #sorryMessage { display: none; }

    /* Autocomplete dropdown */
    .autocomplete-suggestions {
        position: absolute;
        background: #ffffff;
        border: 1px solid #ccc;
        border-radius: 6px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.15);
        max-height: 200px;
        overflow-y: auto;
        z-index: 1000;

        min-width: 250px; 
        width: calc(100% - 40px); 
        left: 50%;
        transform: translateX(-50%);
      }

      .autocomplete-suggestions div {
        background: #ffffff;
        padding: 10px;
        cursor: pointer;
        font-family: 'Raleway', sans-serif;
        font-size: 1em;
        color: #4B2E2E;
      }

      .autocomplete-suggestions div:hover {
        background: #f2f2f2;
      }
    .highlight {
      font-weight: bold;
      color: #4B2E2E;
    }
  </style>
</head>
<body>

  <h1>RSVP for Our Wedding üíç</h1>

  <!-- Attendance question (FIRST) -->
  <div id="selectScreen" class="screen" style="display:block;">
    <p>Will you be attending our wedding? üíç</p>
    <button onclick="startRSVP(true)">Yes</button>
    <button onclick="startRSVP(false)">No</button>
  </div>

  <!-- Name input screen (SECOND) -->
  <div id="nameScreen" class="screen">
    <p>Please enter your full name</p>
    <input type="text" id="guestNameInput" placeholder="Enter your name" autocomplete="off"/>
    <div id="autocomplete-list" class="autocomplete-suggestions"></div>
    <button onclick="checkName()">Continue</button>
  </div>

  <!-- Seat selection screen (THIRD) -->
  <div id="seatScreen" class="screen">
    <h2 id="seatMessage"></h2>
    <p>How many seats will you be occupying?</p>
    <input type="number" id="seatCountInput" min="1" />
    <button onclick="confirmSeats()">Confirm</button>
  </div>

  <!-- RSVP form (FOURTH) -->
  <form id="rsvpForm" class="screen">
    <h2>Guest Names</h2>
    <div id="guestFields"></div>
    <button type="submit">Submit RSVP</button>
  </form>

  <!-- Thank you / decline (FINAL) -->
  <div id="thankYou" class="screen">
    <h3>Thank you! Your RSVP has been submitted.</h3>
    <h3>Your presence will make our day even more special! üéâ</h3>
  </div>
  <div id="sorryScreen" class="screen">
    <h4>Thank you for letting us know üíå</h4>
    <h4>We‚Äôll celebrate with you in spirit üíï</h4>
  </div>

  <div id="alreadyRSVP" class="screen">
    <h2>We have already received your RSVP for this event!</h2>
    <p>Please contact 0917-XXX-XXXX for any clarifications or changes.</p>
  </div>

  <script>
  let inviteList = {}; // will be filled from Google Sheet
  let maxGuests = 0;
  let selectedName = "";
  let guestNumber = 0;
  let attendance = "";

  // Fetch invite list on load
  async function loadInviteList() {
    try {
      const res = await fetch("https://script.google.com/macros/s/AKfycbz_0Nc6tslk3AFka2Za9gdtpy63ucQeCNS_ETQebsL-ecSA86AH6r4RCDnUzW1uq4UF/exec");
      inviteList = await res.json();
      console.log("Invite list loaded:", inviteList);
    } catch (err) {
      console.error("Error loading invite list:", err);
      alert("Could not load invitation list. Please refresh.");
    }
  }

  loadInviteList(); 

  // Autocomplete
  const input = document.getElementById("guestNameInput");
  const suggestionBox = document.getElementById("autocomplete-list");

  input.addEventListener("input", function() {
    const query = this.value.toUpperCase();
    suggestionBox.innerHTML = "";

    if (!query) {
      suggestionBox.style.display = "none";
      return;
    }

    const matches = Object.keys(inviteList).filter(name => name.includes(query));
    if (matches.length === 0) {
      suggestionBox.style.display = "none";
      return;
    }

    suggestionBox.style.display = "block";
    matches.forEach(match => {
      const div = document.createElement("div");
      div.classList.add("autocomplete-suggestion");
      div.innerHTML = match.replace(new RegExp(query, "gi"), (m) => `<span class="highlight">${m}</span>`);
      div.onclick = function() {
        input.value = match;
        suggestionBox.innerHTML = "";
        suggestionBox.style.display = "none";
      };
      suggestionBox.appendChild(div);
    });
  });

  function startRSVP(answer) {
    attendance = answer ? "Yes" : "No";
    document.getElementById("selectScreen").style.display = "none";

    if (answer) {
      document.getElementById("nameScreen").style.display = "block";
    } else {
      // Directly show sorry screen (no name / guest count needed)
      document.getElementById("sorryScreen").style.display = "block";
    }
  }

  async function checkName() {
    selectedName = input.value.trim().toUpperCase();

    if (!inviteList[selectedName]) {
      alert("Name not found. Please enter your name exactly as on the invitation.");
      return;
    }

    try {
      // Call Apps Script to verify if this name already RSVPed
      const res = await fetch(
        "https://script.google.com/macros/s/AKfycbz_0Nc6tslk3AFka2Za9gdtpy63ucQeCNS_ETQebsL-ecSA86AH6r4RCDnUzW1uq4UF/exec?checkName=" 
        + encodeURIComponent(selectedName)
      );
      const data = await res.json();

      if (data.exists) {
        // Already RSVPed ‚Üí show message
        document.getElementById("nameScreen").style.display = "none";
        document.getElementById("alreadyRSVP").style.display = "block";
      } else {
        // Not RSVPed yet ‚Üí continue flow
        maxGuests = inviteList[selectedName];
        document.getElementById("nameScreen").style.display = "none";
        document.getElementById("seatScreen").style.display = "block";
        document.getElementById("seatMessage").innerText = `We've reserved ${maxGuests} seats for you!`;
        document.getElementById("seatCountInput").setAttribute("max", maxGuests);
      }
    } catch (err) {
      console.error("Error checking RSVP:", err);
      alert("Something went wrong while checking your RSVP. Please contact 0917-XXX-XXXX.");
    }
  }

  function confirmSeats() {
    const count = parseInt(document.getElementById("seatCountInput").value, 10);
    if (isNaN(count) || count < 1 || count > maxGuests) {
      alert(`Please enter a valid number between 1 and ${maxGuests}.`);
      return;
    }
    guestNumber = count;
    document.getElementById("seatScreen").style.display = "none";
    document.getElementById("rsvpForm").style.display = "block";
    createGuestFields(count);
  }

  function createGuestFields(n) {
    const container = document.getElementById("guestFields");
    container.innerHTML = "";
    for (let i = 1; i <= n; i++) {
      const input = document.createElement("input");
      input.type = "text";
      input.name = `guest${i}`;
      input.placeholder = `Guest ${i} (First Name Last Name)`;
      input.required = true;
      container.appendChild(input);
    }
  }

  document.getElementById("rsvpForm").addEventListener("submit", function(e) {
    e.preventDefault();
    const guestNames = [];
    for (let i = 1; i <= guestNumber; i++) {
      guestNames.push(this[`guest${i}`].value);
    }

    const payload = {
      name: selectedName,
      guestNumber: guestNumber,
      guestNames: guestNames
    };

    fetch("https://script.google.com/macros/s/AKfycbz_0Nc6tslk3AFka2Za9gdtpy63ucQeCNS_ETQebsL-ecSA86AH6r4RCDnUzW1uq4UF/exec", {
      method: "POST",
      mode: "no-cors",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    // Show thank you screen
    document.getElementById("rsvpForm").style.display = "none";
    document.getElementById("thankYou").style.display = "block";
  });
  
</script>

</body>
</html>
